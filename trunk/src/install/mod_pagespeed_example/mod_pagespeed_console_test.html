<!DOCTYPE html>
<title>Mod Pagespeed Console JSUnit Test</title>
<link rel="stylesheet" href="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/css/jsUnitStyle.css">
<script src="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/app/jsUnitCore.js"></script>
<script src="mod_pagespeed_console.js"></script>
<script src="https://www.google.com/jsapi?autoload=%7B%22modules%22%3A%5B%7B%22name%22%3A%22visualization%22%2C%22version%22%3A%221.0%22%2C%22packages%22%3A%5B%22corechart%22%5D%7D%5D%7D"></script>

<script>

function setUpPage() {
  setUpPageStatus = 'running';
  setTimeout(function() {
    setUpPageStatus = 'complete';
  }, 50);
}

// Tests that the constructor works properly and initialises what it's supposed
// to initialise.
function testConstructor() {
  mpsconsole = new pagespeed.MpsConsole();
  assertNull(mpsconsole.firstScrapeDate_);
  assertNull(mpsconsole.currData_);
  for (var value in mpsconsole.graphs_) {
    assertFalse(mpsconsole.graphs_.hasOwnProperty(value));
  }
  for (var value in mpsconsole.dataTables_) {
    assertFalse(mpsconsole.dataTables_.hasOwnProperty(value));
  }
  assertNotUndefined('mpsconsole.LineGraphNames_', mpsconsole.LineGraphNames_);
  assertNotUndefined('mpsconsole.TIME_WINDOW_SEC', mpsconsole.TIME_WINDOW_SEC);
  assertNotUndefined('mpsconsole.UPDATE_INTERVAL_MS', mpsconsole.UPDATE_INTERVAL_MS);
}

// Tests that the various graph-adding functions work.
function testCreateGraphDiv() {
  mpsconsole = new pagespeed.MpsConsole();
  mpsconsole.createDivs();

  // Test that arbitrary graphs can be added with their anchors and links
  var numDivs = document.getElementsByTagName('div').length;
  var numAs = document.getElementsByTagName('a').length;
  var numBrs = document.getElementsByTagName('br').length;
  mpsconsole.createGraphDiv('blah blah');
  var numDivs2 = document.getElementsByTagName('div').length;
  var numAs2 = document.getElementsByTagName('a').length;
  var numBrs2 = document.getElementsByTagName('br').length;
  assertEquals(numDivs + 1, numDivs2);
  assertEquals(numAs + 2, numAs2);
  assertEquals(numBrs + 1, numBrs2);

  // Test that line graphs and data tables can be generated
  assertNotNull(mpsconsole.getLineGraphDataTable('Arbitrary Title'));
  assertNotNull(mpsconsole.getLineGraph('Arbitrary Title'));
  assertNotNull(mpsconsole.graphs_['Arbitrary Title']);
  assertNotNull(mpsconsole.dataTables_['Arbitrary Title']);

  // Test that histograms and data tables can be generated
  assertNotNull(mpsconsole.getHistogramDataTable('Arbitrary Title B'));
  assertNotNull(mpsconsole.getBarGraph('Arbitrary Title B'));
  assertNotNull(mpsconsole.graphs_['Arbitrary Title B']);
  assertNotNull(mpsconsole.dataTables_['Arbitrary Title B']);

  // Test that line graphs are not arbitrarily generated
  assertUndefined(mpsconsole.graphs_['Arbitrary Title 2']);
  assertUndefined(mpsconsole.dataTables_['Arbitrary Title 2']);
}

// Tests that data parsing and graph generation works correctly in simulated
// normal use.
function testConsole() {
  mpsconsole = new pagespeed.MpsConsole();
  mpsconsole.createDivs();
  var vals = initResponseGenerator(false);
  // These two initial scrapes initialize mpsconsole.currData.
  mpsconsole.scrapeData(generateResponse(vals));
  mpsconsole.scrapeData(generateResponse(vals));
  // Then we scrape the same response twice to set
  // all non-instananeous values to 0.
  var response = generateResponse(vals);
  mpsconsole.scrapeData(response);
  mpsconsole.scrapeData(response);
  for (var value in mpsconsole.dataTables_) {
    if (mpsconsole.dataTables_.hasOwnProperty(value)) {
      var dt = mpsconsole.dataTables_[value];
      assertTrue(dt.getNumberOfRows() > 0);
      var lastRow = dt.getNumberOfRows() - 1;
      var errorMessage = "In Table " + value;
      if (value == mpsconsole.LineGraphNames_.ONGOING_IMG_REWRITES){
        // This value is instananeous and hardcoded below.
        assertEquals(errorMessage, 8, dt.getValue(lastRow, 1));
      } else {
        // After scraping the same response twice, all non-instananeous values,
        // which are calculated by diff'ing with the previous scrape,
        // should be 0.
        assertEquals(errorMessage, 0, dt.getValue(lastRow, 1));
      }
      assertTrue(errorMessage, dt.getValue(lastRow, 0) >= 0);
    }
  }

  // Now test with some real world data (modeled after a load test)
  vals = initResponseGenerator(true);
  mpsconsole.scrapeData(generateResponse(vals));
  mpsconsole.scrapeData(generateResponse(vals));
  mpsconsole.scrapeData(generateResponse(vals));
  mpsconsole.scrapeData(generateResponse(vals));
  mpsconsole.scrapeData(generateResponse(vals));

  // Test that all values are sane (>=0).
  for (var value in mpsconsole.dataTables_) {
    if (mpsconsole.dataTables_.hasOwnProperty(value)) {
      var dt = mpsconsole.dataTables_[value];
      assertTrue(dt.getNumberOfRows() > 0);
      for (var j = 0; j < dt.getNumberOfRows(); j++) {
        var errorMessage = "In Table \'" + value + "\' at row " + j +
            " with value (" + dt.getValue(j, 0) +
            ", " + dt.getValue(j, 1) + ")";
        assertTrue(errorMessage, dt.getValue(j, 1) >= 0);
        assertTrue(errorMessage, dt.getValue(j, 0) >= 0);
      }
    }
  }

  // Test that graphs and data tables are generated
  for (var title in mpsconsole.graphs_) {
    if (mpsconsole.graphs_.hasOwnProperty(title)){
      assertNotNull(mpsconsole.graphs_[title]);
      assertNotNull(mpsconsole.dataTables_[title]);
    }
  }
}

var statValues = [
  'cache_time_us', 'cache_hits', 'cache_misses',
  'cache_expirations', 'cache_inserts', 'cache_deletes',
  'instrumentation_filter_script_added_count', 'cache_extensions',
  'not_cacheable', 'css_file_count_reduction', 'css_filter_blocks_rewritten',
  'css_filter_parse_failures', 'css_filter_fallback_rewrites',
  'css_filter_fallback_failures', 'css_filter_rewrites_dropped',
  'css_filter_total_bytes_saved', 'css_filter_total_original_bytes',
  'css_filter_uses', 'css_imports_to_links', 'css_elements_moved',
  'domain_rewrites', 'google_analytics_page_load_count',
  'google_analytics_rewritten_count', 'image_file_count_reduction',
  'image_rewrites', 'image_norewrites_high_resolution',
  'image_rewrites_dropped_intentionally', 'image_rewrites_dropped_due_to_load',
  'image_rewrite_total_bytes_saved', 'image_rewrite_total_original_bytes',
  'image_rewrite_uses', 'image_inline', 'image_ongoing_rewrites',
  'image_webp_rewrites', 'inserted_ga_snippets', 'javascript_blocks_minified',
  'javascript_minification_failures', 'javascript_total_bytes_saved',
  'javascript_total_original_bytes', 'javascript_minify_uses',
  'js_file_count_reduction', 'converted_meta_tags', 'url_trims',
  'url_trim_saved_bytes', 'resource_url_domain_rejections',
  'rewrite_cached_output_missed_deadline', 'rewrite_cached_output_hits',
  'rewrite_cached_output_misses', 'resource_404_count', 'slurp_404_count',
  'total_page_load_ms', 'page_load_count', 'resource_fetches_cached',
  'resource_fetch_construct_successes', 'resource_fetch_construct_failures',
  'num_flushes', 'num_fallback_responses_served', 'num_conditional_refreshes',
  'total_fetch_count', 'total_rewrite_count', 'num_rewrites_executed',
  'num_rewrites_dropped', 'serf_fetch_request_count', 'serf_fetch_bytes_count',
  'serf_fetch_time_duration_ms', 'serf_fetch_cancel_count',
  'serf_fetch_active_count', 'serf_fetch_timeout_count',
  'serf_fetch_failure_count', 'cache_flush_count'
];

// Return a random integer between 0 and n.
function randomInt(n) {
  return Math.floor(Math.random() * n);
}

// Return a string consisting of a random number of spaces.
function spaces() {
  var ret = ' ';
  var numSpaces = randomInt(20);
  for(var i = 0; i < numSpaces; ++i) {
    ret += ' ';
  }
  return ret;
}

// Initialise an object containing initial values for simulated statistics. If
// load is true, simulate a server under load.
function initResponseGenerator(load) {
  var vals = {}
  vals.load = load;
  for (var i = 0; i < statValues.length; ++i) {
    var v = statValues[i];
    vals[v] = randomInt(load ? 20000 : 10);
  }
  return vals;
}

// Generate a simulated response text. vals should be the value returned from
// initResponseGenerator.
function generateResponse(vals) {
  var ret = '\n&lt;pre&gt;';
  for (var i = 0; i < statValues.length; ++i) {
    var v = statValues[i];
    vals[v] += randomInt(vals.load ? 100 : 2);
    if (v == 'image_ongoing_rewrites') {
      vals[v] = 8;
    }
    ret += v + ':' + spaces() + vals[v] + '\n';
  }
  ret += '&lt;/pre&gt;';
  return ret;
}

</script>
