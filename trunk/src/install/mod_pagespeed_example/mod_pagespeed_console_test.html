<!DOCTYPE html>
<title>Mod Pagespeed Console JSUnit Test</title>

<!-- Some of the functions in mod_pagespeed_console.js require certain layout
     divs to already be in place on the html page.-->
<div id = "toggle-messages"></div>
<select id="graph-list"></select>
<div id="add-filter"></div>
<div id="hide-filter"></div>
<button id="saveButton"></button>
<div id="widget-title"></div>
<div id="container"></div>

<link rel="stylesheet" href="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/css/jsUnitStyle.css">
<script src="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/app/jsUnitCore.js"></script>
<script src="mod_pagespeed_console.js"></script>
<script src="https://www.google.com/jsapi?autoload=%7B%22modules%22%3A%5B%7B%22name%22%3A%22visualization%22%2C%22version%22%3A%221.0%22%2C%22packages%22%3A%5B%22corechart%22%5D%7D%5D%7D"></script>
<script>
// Tests that the constructor works properly and initializes what it's supposed
// to initialize.
function testConstructor() {
  mpsconsole = new pagespeed.MpsConsole();
  assertNotUndefined('mpsconsole.LineGraphs_', mpsconsole.LineGraphs_);
  assertNotUndefined('mpsconsole.Histograms_', mpsconsole.Histograms_);
}

// Tests that data parsing and graph generation works correctly in simulated
// normal use.
function testConsole() {
  mpsconsole = new pagespeed.MpsConsole();
  // Test with some simple data.
  var simpleJSON = generateJSONResponse(false);
  var variableNoTimeSeries = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES);
  var singleVariableTimeSeries = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.NUM_FLUSHES);
  var multipleVariableTimeSeries = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS);
  // TODO(sarahdw, bvb): Test Histogram.
  ensureSaneValues(variableNoTimeSeries,
                   mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES);
  ensureSaneValues(singleVariableTimeSeries,
                   mpsconsole.LineGraphIndexes.NUM_FLUSHES);
  ensureSaneValues(multipleVariableTimeSeries,
                   mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS); 
  checkHardcodedValues(variableNoTimeSeries,
                       mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES);
  checkHardcodedValues(singleVariableTimeSeries,
                       mpsconsole.LineGraphIndexes.NUM_FLUSHES);
  checkHardcodedValues(multipleVariableTimeSeries,
                       mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS);
  // Now test with some real world data (modeled after a load test).
  var loadTestJSON = generateJSONResponse(true);
  var variableNoTimeSeriesLoad = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES);
  var singleVariableTimeSeriesLoad = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.NUM_FLUSHES);
  var multipleVariableTimeSeriesLoad = mpsconsole.computeTimeSeries(
      simpleJSON['variables'], simpleJSON['timestamps'],
      mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS);
  ensureSaneValues(variableNoTimeSeriesLoad,
                   mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES);
  ensureSaneValues(singleVariableTimeSeriesLoad,
                   mpsconsole.LineGraphIndexes.NUM_FLUSHES);
  ensureSaneValues(multipleVariableTimeSeriesLoad,
                   mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS);
}

function testQueryURICreation() {
  mpsconsole = new pagespeed.MpsConsole();
  var filters = "/mod_pagespeed_statistics?json&start_time=0&end_time=10&granularity=5";
  var queryStringMultipleVar = mpsconsole.createQueryURI(false,
      mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS, 0, 10, 5);
  assertEquals(filters + "&var_titles=cache_hits,cache_misses,",
               queryStringMultipleVar);
  var queryStringSingleVar = mpsconsole.createQueryURI(false,
      mpsconsole.LineGraphIndexes.NUM_FLUSHES, 0, 10, 5);
  assertEquals(filters + "&var_titles=num_flushes,", queryStringSingleVar);
  var queryStringHistogram = mpsconsole.createQueryURI(true,
      mpsconsole.HistogramIndexes.HTML_TIME, 0, 10, 5);
  assertEquals(filters + "&hist_titles=Html Time us Histogram,",
               queryStringHistogram);
}

var var_titles = ['num_flushes', 'cache_hits', 'cache_misses',
      'num_fallback_responses_served', 'slurp_404_count', 'page_load_count',
      'total_page_load_ms', 'num_rewrites_executed', 'num_rewrites_dropped',
      'resource_404_count', 'serf_fetch_request_count',
      'serf_fetch_bytes_count', 'image_ongoing_rewrites'];
var hist_titles = ['Html Time us Histogram', 'Rewrite Latency Histogram',
      'Pagespeed Resource Latency Histogram',
      'Backend Fetch First Byte Latency Histogram'];

function makeTimeStamps() {
  var timestamps = [];
  var startingTimeMs = 1342724700000; // Arbitrary time in July 2012.
  for (var i = 0; i < 20; i++) {
    timestamps.push(startingTimeMs + (i*3000));
  }
  return timestamps;
}

// Return a random integer between 0 and n.
function randomInt(n) {
  return Math.floor(Math.random() * n);
}

// Initialize an object containing initial values for simulated statistics.
function initResponseGenerator() {
  var vals = {}
  for (var i = 0; i < var_titles.length; ++i) {
    var v = var_titles[i];
    if (v == 'image_ongoing_rewrites') {
      vals[v] = 8;
    } else {
      vals[v] = 0;
    }
  }
  return vals;
}

// Generate a simulated JSON response object. load should be true if we want to
// simulate a server under load. If load is false, we hardcode certain values.
function generateJSONResponse(load) {
  var timestamps = makeTimeStamps();
  var vals = initResponseGenerator(load);
  var ret = {};
  ret.timestamps = [];
  for (var i = 0; i < timestamps.length; ++i) {
    ret.timestamps.push(timestamps[i]);
  }
  ret.variables = {};
  for (var i = 0; i < var_titles.length; ++i) {
    var v = var_titles[i];
    ret.variables[v] = [];
    for (var t = 0; t < timestamps.length; ++t) {
      ret.variables[v][t] = vals[v];
      if (v == 'image_ongoing_rewrites') {
        vals[v] = 8;
      } else if (load) {
        vals[v] += randomInt(100);
      } else if (!load) {
        // Hardcode values to test math.
        if (v == 'num_flushes') {
          // FLUSHES_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'cache_hits') {
          vals[v] += 10;
        } else if (v == 'cache_misses') {
          // PERCENT_CACHE_HITS = .5
          vals[v] += 10;
        } else if (v == 'num_fallback_responses_served') {
          // FALLBACK_RESPONSES = 20
          vals[v] += 60;
        } else if (v == 'slurp_404_count') {
          // SLURP_404S_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'page_load_count') {
          vals[v] += 20;
        } else if (v == 'total_page_load_ms') {
          // AVE_LOAD_TIME_MS = 10
          vals[v] += 200;
        } else if (v == 'num_rewrites_executed') {
          // REWRITES_EXEC_PER_SECOND = 30
          vals[v] += 90;
        } else if (v == 'num_rewrites_dropped') {
          // REWRITES_DROPPED_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'resource_404_count') {
          // RESOURCE_404S_PER_SECOND = 30
          vals[v] += 90;
        } else if (v == 'serf_fetch_request_count') {
          vals[v] += 10;
        } else if (v == 'serf_fetch_bytes_count') {
          // SERF_BYTES_PER_REQUEST = 200
          vals[v] += 2000;
        }
      }
    }
  }
  ret.histograms = {};
  for (var i = 0; i < hist_titles.length; ++i) {
    var h = ret.histograms[hist_titles[i]] = [];
    for (var j = 0; j < 10000; j += 400) {
      var bar = {};
      bar.lowerBound = j;
      bar.upperBound = j + 400;
      bar.count = randomInt(load ? 100 : 10);
      h.push(bar);
    }
  }
  return ret;
}

// Check that the unloaded values match what we hardcoded.
function checkHardcodedValues(data, value) {
  for (var i = 0; i < data.length; i++) {
    var errorMessage = "In Table \'" + value + "\' at row " + i +
        " with value (" + data[i] + ")";
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.PERCENT_CACHE_HITS].title) {
      assertEquals(errorMessage, 0.5, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.NUM_FLUSHES].title) {
      assertEquals(errorMessage, 10, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.FALLBACK_RESPONSES].title) {
      assertEquals(errorMessage, 20, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.RESOURCE_404S].title) {
      assertEquals(errorMessage, 30, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.SLURP_404S].title) {
      assertEquals(errorMessage, 10, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.AVG_LOAD_TIME].title) {
      assertEquals(errorMessage, 10, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.SERF_BYTES_FETCHED].title) {
      assertEquals(errorMessage, 200, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.REWRITES_EXECUTED].title) {
      assertEquals(errorMessage, 30, data[i]);
    }
    if (value == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.REWRITES_DROPPED].title) {
      assertEquals(errorMessage, 10, data[i]);
    }
  }
}

// Test that all values in the mpsconsole are sane (>=0).
function ensureSaneValues(data, graphIndex) {
  assertTrue(data.length > 0);
  var graphTitle = mpsconsole.LineGraphs_[graphIndex].title;
  for (var i = 0; i < data.length; i++) {
    var value = data[i];
    var errorMessage = "Value \'" + value + "\' at row " + i +
        " in graph " + graphTitle;
    if (graphTitle == mpsconsole.LineGraphs_[mpsconsole.LineGraphIndexes.ONGOING_IMG_REWRITES].title) {
      // This value is static and is hardcoded below.
      assertTrue(errorMessage, value == 8);
    } else {
      assertTrue(errorMessage, value >= 0);
    }
  }
}
</script>
