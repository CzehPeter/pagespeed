<!DOCTYPE html>
<title>Mod Pagespeed Console JSUnit Test</title>
<link rel="stylesheet" href="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/css/jsUnitStyle.css">
<script src="file:///home/build/nonconf/google3/third_party/java/jsunit/jsunit2.2/app/jsUnitCore.js"></script>
<script src="mod_pagespeed_console.js"></script>
<script src="https://www.google.com/jsapi?autoload=%7B%22modules%22%3A%5B%7B%22name%22%3A%22visualization%22%2C%22version%22%3A%221.0%22%2C%22packages%22%3A%5B%22corechart%22%5D%7D%5D%7D"></script>

<script>

// Tests that the constructor works properly and initializes what it's supposed
// to initialize.
function testConstructor() {
  mpsconsole = new pagespeed.MpsConsole();
  for (var value in mpsconsole.graphs_) {
    assertFalse(mpsconsole.graphs_.hasOwnProperty(value));
  }
  for (var value in mpsconsole.dataTables_) {
    assertFalse(mpsconsole.dataTables_.hasOwnProperty(value));
  }
  assertNotUndefined('mpsconsole.LineGraphNames_', mpsconsole.LineGraphNames_);
  assertNotUndefined('mpsconsole.TIME_WINDOW_SEC', mpsconsole.TIME_WINDOW_SEC);
  assertNotUndefined('mpsconsole.UPDATE_INTERVAL_MS', mpsconsole.UPDATE_INTERVAL_MS);
}

// Tests that the various graph-adding functions work.
function testCreateGraphDiv() {
  mpsconsole = new pagespeed.MpsConsole();
  mpsconsole.createDivs();

  // Test that line graphs and data tables can be generated
  assertNotNull(mpsconsole.getLineGraphDataTable('Arbitrary Title'));
  assertNotNull(mpsconsole.getLineGraph('Arbitrary Title'));

  assertNotNull(mpsconsole.graphs_['Arbitrary Title']);
  assertNotNull(mpsconsole.dataTables_['Arbitrary Title']);

  // Test that histograms and data tables can be generated
  assertNotNull(mpsconsole.getHistogramDataTable('Arbitrary Title B'));
  assertNotNull(mpsconsole.getBarGraph('Arbitrary Title B'));

  assertNotNull(mpsconsole.graphs_['Arbitrary Title B']);
  assertNotNull(mpsconsole.dataTables_['Arbitrary Title B']);

  // Test that line graphs are not arbitrarily generated
  assertUndefined(mpsconsole.graphs_['Arbitrary Title 2']);
  assertUndefined(mpsconsole.dataTables_['Arbitrary Title 2']);
}

// Tests that data parsing and graph generation works correctly in simulated
// normal use.
function testConsole() {
  mpsconsole = new pagespeed.MpsConsole();
  mpsconsole.createDivs();
  mpsconsole.initVarGraphData();

  // Test with some simple data.
  mpsconsole.scrapeData(generateJSONResponse(false));
  ensureSaneValues(mpsconsole);
  checkHardcodedValues(mpsconsole);

  // Now test with some real world data (modeled after a load test).
  mpsconsole.scrapeData(generateJSONResponse(true));
  ensureSaneValues(mpsconsole);

  // Test that graphs and data tables are generated
  for (var title in mpsconsole.graphs_) {
    if (mpsconsole.graphs_.hasOwnProperty(title)){
      assertNotNull(mpsconsole.graphs_[title]);
      assertNotNull(mpsconsole.dataTables_[title]);
    }
  }
}

var var_titles = ['num_flushes', 'cache_hits', 'cache_misses',
      'num_fallback_responses_served', 'slurp_404_count', 'page_load_count',
      'total_page_load_ms', 'num_rewrites_executed', 'num_rewrites_dropped',
      'resource_404_count', 'serf_fetch_request_count',
      'serf_fetch_bytes_count', 'image_ongoing_rewrites'];
var hist_titles = ['Html Time us Histogram', 'Rewrite Latency Histogram',
      'Pagespeed Resource Latency Histogram',
      'Backend Fetch First Byte Latency Histogram'];

function makeTimeStamps() {
  var timestamps = [];
  for (var i = 0; i < 20; i++) {
    timestamps.push(1342724700000 + (i*3000));
  }
  return timestamps;
}

// Return a random integer between 0 and n.
function randomInt(n) {
  return Math.floor(Math.random() * n);
}

// Initialize an object containing initial values for simulated statistics.
function initResponseGenerator() {
  var vals = {}
  for (var i = 0; i < var_titles.length; ++i) {
    var v = var_titles[i];
    if (v == 'image_ongoing_rewrites') {
      vals[v] = 8;
    } else {
      vals[v] = 0;
    }
  }
  return vals;
}

// Generate a simulated JSON response object. load should be true if we want to
// simulate a server under load. If load is false, we hardcode certain values.
function generateJSONResponse(load) {
  var timestamps = makeTimeStamps();
  var vals = initResponseGenerator(load);
  var ret = {};
  ret.timestamps = [];
  for (var i = 0; i < timestamps.length; ++i) {
    ret.timestamps.push(timestamps[i]);
  }
  ret.variables = {};
  for (var i = 0; i < var_titles.length; ++i) {
    var v = var_titles[i];
    ret.variables[v] = {};
    for (var t = 0; t < timestamps.length; ++t) {
      ret.variables[v][timestamps[t]] = vals[v];
      if (v == 'image_ongoing_rewrites') {
        vals[v] = 8;
      } else if (load) {
        vals[v] += randomInt(100);
      } else if (!load) {
        // Hardcode values to test math.
        if (v == 'num_flushes') {
          // FLUSHES_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'cache_hits') {
          vals[v] += 10;
        } else if (v == 'cache_misses') {
          // PERCENT_CACHE_HITS = .5
          vals[v] += 10;
        } else if (v == 'num_fallback_responses_served') {
          // FALLBACK_RESPONSES = 20
          vals[v] += 60;
        } else if (v == 'slurp_404_count') {
          // SLURP_404S_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'page_load_count') {
          vals[v] += 20;
        } else if (v == 'total_page_load_ms') {
          // AVE_LOAD_TIME_MS = 10
          vals[v] += 200;
        } else if (v == 'num_rewrites_executed') {
          // REWRITES_EXEC_PER_SECOND = 30
          vals[v] += 90;
        } else if (v == 'num_rewrites_dropped') {
          // REWRITES_DROPPED_PER_SECOND = 10
          vals[v] += 30;
        } else if (v == 'resource_404_count') {
          // RESOURCE_404S_PER_SECOND = 30
          vals[v] += 90;
        } else if (v == 'serf_fetch_request_count') {
          vals[v] += 10;
        } else if (v == 'serf_fetch_bytes_count') {
          // SERF_BYTES_PER_REQUEST = 200
          vals[v] += 2000;
        }
      }
    }
  }
  ret.histograms = {};
  for (var i = 0; i < hist_titles.length; ++i) {
    var h = ret.histograms[hist_titles[i]] = [];
    for (var j = 0; j < 10000; j += 400) {
      var bar = {};
      bar.lowerBound = j;
      bar.upperBound = j + 400;
      bar.count = randomInt(load ? 100 : 10);
      h.push(bar);
    }
  }
  return ret;
}

// Check that the unloaded values match what we hardcoded.
function checkHardcodedValues(mpsconsole) {
  for (var value in mpsconsole.LineGraphNames_) {
    value = mpsconsole.LineGraphNames_[value];
    if (mpsconsole.dataTables_.hasOwnProperty(value)) {
      var dt = mpsconsole.dataTables_[value];
      for (var j = 0; j < dt.getNumberOfRows(); j++) {
        var errorMessage = "In Table \'" + value + "\' at row " + j +
            " with value (" + dt.getValue(j, 0) +
            ", " + dt.getValue(j, 1) + ")";
        if (value == mpsconsole.LineGraphNames_.PERCENT_CACHE_HITS) {
          assertEquals(errorMessage, 0.5, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.FLUSHES_PER_SECOND) {
          assertEquals(errorMessage, 10, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.FALLBACK_RESPONSES) {
          assertEquals(errorMessage, 20, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.RESOURCE_404S_PER_SECOND) {
          assertEquals(errorMessage, 30, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.SLURP_404S_PER_SECOND) {
          assertEquals(errorMessage, 10, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.AVE_LOAD_TIME_MS) {
          assertEquals(errorMessage, 10, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.SERF_BYTES_PER_REQUEST) {
          assertEquals(errorMessage, 200, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.REWRITES_EXEC_PER_SECOND) {
          assertEquals(errorMessage, 30, dt.getValue(j, 1));
        }
        if (value == mpsconsole.LineGraphNames_.REWRITES_DROPPED_PER_SECOND) {
          assertEquals(errorMessage, 10, dt.getValue(j, 1));
        }
      }
    }
  }
}

// Test that all values in the mpsconsole are sane (>=0).
function ensureSaneValues(mpsconsole) {
  for (var value in mpsconsole.LineGraphNames_) {
    if (mpsconsole.dataTables_.hasOwnProperty(value)) {
      var dt = mpsconsole.dataTables_[value];
      assertTrue(dt.getNumberOfRows() > 0);
      for (var j = 0; j < dt.getNumberOfRows(); j++) {
        var errorMessage = "In Table \'" + value + "\' at row " + j +
            " with value (" + dt.getValue(j, 0) +
            ", " + dt.getValue(j, 1) + ")";
        assertTrue(errorMessage, dt.getValue(j, 1) >= 0);
        assertTrue(errorMessage, dt.getValue(j, 0) >= 0);
        if (value == mpsconsole.LineGraphNames_.ONGOING_IMG_REWRITES) {
          // This value is static and is hardcoded below.
          assertTrue(errorMessage, dt.getValue(j, 1) == 8);
        }
      }
    }
  }
}

</script>
